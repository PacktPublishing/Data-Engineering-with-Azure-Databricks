trigger: none

pr:
  branches:
    include:
      - main

pool:
  vmImage: "ubuntu-latest"

variables:
  - group: databricks-dev
  - name: pythonVersion
    value: "3.11"

stages:
  - stage: CI
    displayName: "PR Validation"
    jobs:
      - job: ValidateAndTest
        displayName: "Validate, test & deploy to dev"
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: $(pythonVersion)
            displayName: "Set up Python $(pythonVersion)"

          - script: pip install -r requirements-test.txt
            displayName: "Install test dependencies"

          - script: |
              curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
            displayName: "Install Databricks CLI"

          - script: databricks bundle validate -t dev_ci
            displayName: "Validate bundle (dev target)"
            env:
              DATABRICKS_HOST: $(DATABRICKS_HOST)
              DATABRICKS_TOKEN: $(DATABRICKS_TOKEN)

          - script: >
              pytest test/unit_test/
              --junitxml=test-results.xml
              --cov=src
              --cov-report=xml:coverage.xml
              --cov-report=term
            displayName: "Run unit tests with coverage"
            env:
              DATABRICKS_HOST: $(DATABRICKS_HOST)
              DATABRICKS_TOKEN: $(DATABRICKS_TOKEN)

          - task: PublishTestResults@2
            condition: succeededOrFailed()
            inputs:
              testResultsFiles: test-results.xml
              testRunTitle: "CI Unit Tests"
            displayName: "Publish test results"

          - task: PublishCodeCoverageResults@2
            condition: succeededOrFailed()
            inputs:
              summaryFileLocation: coverage.xml
            displayName: "Publish code coverage"

          - script: databricks bundle deploy -t dev_ci --force --auto-approve
            displayName: "Deploy bundle to dev"
            env:
              DATABRICKS_HOST: $(DATABRICKS_HOST)
              DATABRICKS_TOKEN: $(DATABRICKS_TOKEN)